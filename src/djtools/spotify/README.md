# Spotify

## Contents
* Overview
* Setup
* Usage

# Overview
The `spotify` package contains modules:
* `helpers`: helper functions for `playlist_builder`
* `playlist_builder`: constructs or updates Spotify playlists using either Subreddit posts or the Discord webhook output from `UPLOAD_MUSIC`

# Setup
To begin using the `spotify` package, you must create a Spotify API application by following [these instructions](https://developer.spotify.com/documentation/web-api/quick-start/). Once you've registered your application, you must populate the `SPOTIFY_CLIENT_ID`, `SPOTIFY_CLIENT_SECRET`, and `SPOTIFY_REDIRECT_URI` configuration options in `config.yaml`.

If using `AUTO_PLAYLIST_UPDATE`, you must also create a Reddit API application by following [these instructions](https://rymur.github.io/setup). Once you've registered your application, you must populate the `REDDIT_CLIENT_ID`, `REDDIT_CLIENT_SECRET`, and `REDDIT_USER_AGENT` configuration options in `config.yaml`.

If using either the `AUTO_PLAYLIST_UPDATE` or `PLAYLIST_FROM_UPLOAD`, `SPOTIFY_USERNAME` must be set to the Spotify username of whoever will keep the playlists on their account.

# Usage

## playlist_builder
In order to use `AUTO_PLAYLIST_UPDATE` or `PLAYLIST_FROM_UPLOAD`, you must have `spotify_playlists.yaml` in the `config` folder. This YAML contains playlist names as keys and Spotify playlist IDs as values. If the playlist names are used for `AUTO_PLAYLIST_UPDATE`, the YAML keys _MUST_ match a valid Subreddit (case-insensitive) because these names are used to query the Reddit API. Playlist names for `PLAYLIST_FROM_UPLOAD` are automatically generated using the usernames present in the Discord webhook output. `spotify_playlists.yaml` may also contain other playlists not used by either the `AUTO_PLAYLIST_UPDATE` or `PLAYLIST_FROM_UPLOAD` (i.e. `CHECK_TRACKS`).

`NOTE`: Top-level folders inside of "DJ Music" should be the usernames of Beatcloud users; the Spotify playlists generated by `PLAYLISTS_FROM_UPLOAD` function will be named "<folder_name> Uploads". If the names of these playlists are changed from the "<folder_name> Uploads" format, or the top-level folders of "DJ Music" are not usernames, then you will experience unexpected results when using `PLAYLIST_FROM_UPLOAD` or `DOWNLOAD_MUSIC` in combination with `DOWNLOAD_SPOTIFY`.

For `AUTO_PLAYLIST_UPDATE` to work, you must add configuration objects for the Subreddit playlist names you want to generate or update to `AUTO_PLAYLIST_SUBREDDITS`.

Each element of `AUTO_PLAYLIST_SUBREDDITS` is a mapping of Subreddit-specific configuration options:
* `name` is the Subreddit name.
* `type` is whether to query Subreddit's "hot", "top", "new", "rising", or "controversial" posts
* `period` is the time period for which posts are considered (`week` is recommended)
* `limit` is the maximum number of tracks in the auto-playlist; the oldest track will be removed when adding a new track exceeds this limit
`NOTE`: only `name` is required as the rest well be populated by the corresponding config options, e.g. `AUTO_PLAYLIST_DEFAULT_TYPE`.

`AUTO_PLAYLIST_FUZZ_RATIO` `[0, 100]` sets the minimum similarity to add tracks to an auto-playlist when comparing the Subreddit post title to a Spotify API search result. It's also used by the `PLAYLIST_FROM_UPLOAD` function to compare Spotify search results with file names present in the Discord webhook output from `UPLOAD_MUSIC`.

`AUTO_PLAYLIST_POST_LIMIT` `[0, 999]` restricts the number of Subreddit posts to consider when attempting to search Spotify for tracks. If this option isn't specified, then a value of `500` will be used. If the option's value is falsey, then `None` will be used i.e. there will be no limit and 999 posts will be retrieved (if possible). 

Triggering `AUTO_PLAYLIST_UPDATE` can be done by setting `AUTO_PLAYLIST_UPDATE: true` in `config.yaml` or else running `djtools` with the `--auto-playlist-update` flag.

Triggering `PLAYLIST_FROM_UPLOAD` can be done by setting `PLAYLIST_FROM_UPLOAD: true` in `config.yaml` or else running `djtools` with the `--playlist-from-upload` flag. Discord webhook output must be copied to the system clipboard.
